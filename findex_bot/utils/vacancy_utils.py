import re
import datetime

# --- –ù–∞–±–æ—Ä –º–∞—Ç–æ–≤ / –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤ ---
# –î–µ–ª–∞–µ–º –ø–æ –∫–æ—Ä–Ω—è–º, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã:
# "–∂–æ–ø–∞", "–∂–æ–ø–æ–π", "–∂–æ–ø—ã" ‚Üí "–∂–æ–ø"
# "—Ö—É–π", "—Ö—É–π–Ω—è", "—Ö—É—ë–≤–æ" ‚Üí "—Ö—É–π"
BAD_WORD_PATTERNS = [
    "–∂–æ–ø",
    "—Ö—É–π",
    "–ø–∏–∑–¥",
    "–µ–±–∞",
    "–µ–±–∞–ª",
    "—Å—É–∫–∞",
    "–±–ª—è",
    "–±–ª—è–¥",
]


def normalize_text(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç:
    - –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    - –∑–∞–º–µ–Ω—è–µ–º —Ç–∏—Ä–µ/–¥–ª–∏–Ω–Ω—ã–µ —Ç–∏—Ä–µ –∏ –ø—Ä–æ—á–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –Ω–∞ –ø—Ä–æ–±–µ–ª
    """
    if not text:
        return ""

    lowered = text.lower()

    # –∑–∞–º–µ–Ω—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏—Ä–µ/—Å–ª—ç—à –∏ —Ç.–ø. –Ω–∞ –ø—Ä–æ–±–µ–ª
    for ch in ["‚Äî", "-", "_", "/", "\\"]:
        lowered = lowered.replace(ch, " ")

    return lowered


def contains_bad_words(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –º–∞—Ç.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ —Ö–æ—Ç—å –æ–¥–Ω–æ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–µ —Å–ª–æ–≤–æ.
    """
    if not text:
        return False

    normalized = normalize_text(text)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å "—Ö—É–π–Ω—è", "–∂–æ–ø–∞", "–∂–æ–ø–æ–π" –∏ —Ç.–ø.
    for pattern in BAD_WORD_PATTERNS:
        if pattern in normalized:
            return True

    return False


def is_valid_city_input(city: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞.

    –ü—Ä–∞–≤–∏–ª–∞ (–ø–æ–¥ —Ç–µ—Å—Ç—ã –∏ —Ç–≤–æ–π –¢–ó):
    - —Ç–æ–ª—å–∫–æ –ö–ò–†–ò–õ–õ–ò–¶–ê (—Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã) + –ø—Ä–æ–±–µ–ª—ã + —Ç–∏—Ä–µ
    - –±–µ–∑ —Ü–∏—Ñ—Ä
    - –±–µ–∑ –ª–∞—Ç–∏–Ω–∏—Ü—ã
    - –±–µ–∑ —Å–º–∞–π–ª–æ–≤ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤

    –ü—Ä–∏–º–µ—Ä—ã:
    - "–ú–æ—Å–∫–≤–∞"      ‚Üí True
    - "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥" ‚Üí True
    - "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥" ‚Üí True
    - "Hello"       ‚Üí False
    - "–ú–æ—Å–∫–≤–∞123"   ‚Üí False
    """
    if not city:
        return False

    city = city.strip()

    # –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã + –ø—Ä–æ–±–µ–ª—ã + –¥–µ—Ñ–∏—Å
    pattern = r"[–ê-–Ø–∞-—è–Å—ë\s\-]+"

    return bool(re.fullmatch(pattern, city))


def make_hashtag(text: str) -> str:
    """
    –î–µ–ª–∞–µ—Ç —Ö—ç—à—Ç–µ–≥ –∏–∑ —Å—Ç—Ä–æ–∫–∏:
    - —É–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä (–ª–∞—Ç–∏–Ω–∏—Ü–∞ + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
    - —Å–∫–ª–µ–∏–≤–∞–µ—Ç
    - –¥–æ–±–∞–≤–ª—è–µ—Ç # –≤ –Ω–∞—á–∞–ª–æ, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å
    """
    if not text:
        return ""

    cleaned = re.sub(r"[^0-9A-Za-z–ê-–Ø–∞-—è–Å—ë]+", "", text)
    return f"#{cleaned}" if cleaned else ""


def get_ad_text(data: dict, include_author: bool = False) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ / –º–æ–¥–µ—Ä–∞—Ü–∏–∏.

    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–µ —Ä–æ–ª–∏:
    - –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å
    - –°–æ–∏—Å–∫–∞—Ç–µ–ª—å

    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥–æ–≥–Ω–∞–Ω–∞ –ø–æ–¥ —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É –±–æ—Ç–∞ –∏ —Ç–µ—Å—Ç—ã.
    """
    role = data.get("role", "–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å")
    position = data.get("position", "")
    location = data.get("location", "")
    salary = data.get("salary", "")
    contacts = data.get("contacts", "")
    description = data.get("description", "")
    schedule = data.get("schedule", "")

    tags = f"#FindexHub {make_hashtag(position)} {make_hashtag(location)}".strip()

    if role == "–°–æ–∏—Å–∫–∞—Ç–µ–ª—å":
        # –î–ª—è —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º (schedule),
        # —á—Ç–æ–±—ã –ø—Ä–æ—Ö–æ–¥–∏–ª —Ç–µ—Å—Ç test_get_ad_text_seeker.
        text = (
            f"{role}\n\n"
            f"üë§ –î–æ–ª–∂–Ω–æ—Å—Ç—å: {position}\n"
            f"üïí –ì—Ä–∞—Ñ–∏–∫: {schedule}\n"
            f"üí≤ –ó–∞—Ä–ø–ª–∞—Ç–∞: {salary}\n"
            f"üìç –õ–æ–∫–∞—Ü–∏—è: {location}\n"
            f"‚òéÔ∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã: {contacts}\n"
            f"üìù –û —Å–µ–±–µ:\n{description}\n\n"
            f"{tags}"
        )
    else:
        # –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å
        text = (
            f"{role}\n\n"
            f"üë§ –î–æ–ª–∂–Ω–æ—Å—Ç—å: {position}\n"
            f"üí≤ –ó–∞—Ä–ø–ª–∞—Ç–∞: {salary}\n"
            f"üìç –õ–æ–∫–∞—Ü–∏—è: {location}\n"
            f"‚òéÔ∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã: {contacts}\n"
            f"üìù –û–ø–∏—Å–∞–Ω–∏–µ:\n{description}\n\n"
            f"{tags}"
        )

    if include_author and data.get("author"):
        text += f"\n\n–ê–≤—Ç–æ—Ä: {data.get('author')}"

    return text

